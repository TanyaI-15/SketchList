<!-- Create the layout template that extends to all other templates.-->
 <!DOCTYPE html>
<html lang="en">

<head>
    <!-- Make the application usable on both pc and mobile. -->
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">

    <link rel="icon" type="image/png" href="{{ url_for('static', filename='favicon.png') }}">
    <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}?v=1">

    <!-- Bootstrap CSS link for making the app presentable. -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet" 
          integrity="sha384-QWTKZyjpPEjISv5WaRU9OFeRpok6YctnYmDr5pNlyT2bRjXh0JMhjY6hW+ALEwIH" crossorigin="anonymous">
    <!-- Bootstrap JS. -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js" 
            integrity="sha384-YvpcrYf0tY3lHB60NNkmXc5s9fDVZLESaAA55NDzOxhy9GkcIdslK1eN7N6jIeHz" crossorigin="anonymous">
    </script>
</head>

<body>
    <header>
        <h1><a class="link-success link-offset-2 link-underline-opacity-25 link-underline-opacity-100-hover"
             href="{{ url_for('index') }}">SketchList</a></h1>
        {% if session.get("user_id") %}
            <!-- Bootstrap-style navbar for homepage presentation. -->
            <nav class="navbar navbar-expand-lg custom-navbar">
                <div class="container-fluid">
                    <div class="collapse navbar-collapse" id="navbarNav">
                        <ul class="navbar-nav me-auto mb-2 mb-lg-0">
                            <li class="nav-item"><a class="nav-link active" href="{{ url_for('add_todo') }}">Add Todo</a></li>
                        </ul>
                        <ul class="navbar-nav">
                                <li class="nav-item"><a class="nav-link" href="{{ url_for('logout') }}">Logout</a></li>
                        </ul>
                    </div>
                </div>
            </nav>
        {% endif %}
    </header>

    <!-- Flash messages. -->
    {% with messages = get_flashed_messages() %}
        {% if messages %}
            <ul class="alert alert-info" role="alert">
                {% for message in messages %}
                    <li>{{ message }}</li>
                {% endfor %}
            </ul>
        {% endif %}
    {% endwith %}

    <!-- Main content block. -->
    <main class="container mt-4">
        {% block main %}
        {% endblock %}
    </main>

    <footer class="text-center mt-5">
        <img src="{{ url_for('static', filename='favicon.png') }}" alt="favicon" width="53" height="53">
        <small>SketchList by Tanya Isaacs.</small>
    </footer>

    <!-- Timezone Script to centralize the timezone user is in. -->
    <script>
        const timezone = Intl.DateTimeFormat().resolvedOptions().timeZone;
        fetch("/set-timezone", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ timezone })
        });
    </script>

    <!--Toggle the password to help user check if it is typed correctly when logging in.-->
    <script>
        document.addEventListener("DOMContentLoaded", function () {
            document.getElementById("showLogin").addEventListener("change", function() {
                const passwordLogin = document.getElementById("passwordLogin");
                passwordLogin.type = this.checked ? "text" : "password";
            });
        });
    </script>

    <!--Toggle the password to help user check if it is typed correctly when registering.-->
    <script>
        document.addEventListener("DOMContentLoaded", function () {
            document.getElementById("showRegisterPassword").addEventListener("change", function() {
                const fields = [
                    document.getElementById("confirm"),
                    document.getElementById("password")
                ];
                fields.forEach(f => f.type = this.checked ? "text" : "password");
            });
        });
    </script>

    <!-- Drawing canvas script to activate the drawing feature in the application. -->
    <script>
        document.addEventListener("DOMContentLoaded", function () {
            // Only proceed if canvas exists on this page
            const canvas = document.getElementById("drawingCanvas");
            if (!canvas) return; 

            const ctx = canvas.getContext("2d");

            const colorPicker = document.getElementById("colorPicker");
            const thickness = document.getElementById("thickness");
            const eraser = document.getElementById("eraser");
            const clear = document.getElementById("clear");
            const drawingData = document.getElementById("drawing_data");

            let drawing = false;
            let currentColor = colorPicker?.value || "#000000";
            let currentWidth = thickness?.value || 2;
            let isErasing = false;

            // Setup tools safely
            if (colorPicker) {
                colorPicker.addEventListener("input", () => {
                    currentColor = colorPicker.value;
                    isErasing = false;
                });
            }

            if (thickness) {
                thickness.addEventListener("input", () => {
                    currentWidth = thickness.value;
                });
            }

            if (eraser) {
                eraser.addEventListener("click", () => {
                    isErasing = true;
                });
            }

            if (clear) {
                clear.addEventListener("click", () => {
                    ctx.clearRect(0, 0, canvas.width, canvas.height);
                    // Reset to normal drawing.
                    ctx.globalCompositeOperation = "source-over";
                    if (drawingData) drawingData.value = "";
                });
            }

            // Mouse + touch events
            canvas.addEventListener("mousedown", startDraw);
            canvas.addEventListener("mouseup", endDraw);
            canvas.addEventListener("mousemove", draw);

            canvas.addEventListener("touchstart", startDraw);
            canvas.addEventListener("touchend", endDraw);
            canvas.addEventListener("touchmove", drawTouch);

            function getXY(e) {
                const rect = canvas.getBoundingClientRect();
                const x = (e.clientX || e.touches?.[0]?.clientX) - rect.left;
                const y = (e.clientY || e.touches?.[0]?.clientY) - rect.top;
                return { x, y };
            }

            function startDraw(e) {
                e.preventDefault();
                drawing = true;
                const { x, y } = getXY(e);
                ctx.beginPath();
                ctx.moveTo(x, y);
                ctx.lineWidth = currentWidth;
            }

            function endDraw(e) {
                e.preventDefault();
                drawing = false;
                ctx.closePath();
                // Reset the normal drawing.
                ctx.globalCompositeOperation = "source-over";
                if (drawingData) drawingData.value = canvas.toDataURL();
            }

            function draw(e) {
                if (!drawing) return;
                e.preventDefault();
                const { x, y } = getXY(e);

                ctx.lineWidth = currentWidth;

                if (isErasing) {
                    ctx.globalCompositeOperation = "destination-out";
                    ctx.strokeStyle = "rgba(0,0,0,1)"; // color doesn’t matter
                } else {
                    ctx.globalCompositeOperation = "source-over";
                    ctx.strokeStyle = currentColor;
                }
                ctx.lineTo(x, y);
                ctx.stroke();
            }

            function drawTouch(e) {
                if (!drawing) return;
                e.preventDefault();
                const { x, y } = getXY(e);

                ctx.lineWidth = currentWidth;

                if (isErasing) {
                    ctx.globalCompositeOperation = "destination-out";
                    ctx.strokeStyle = "rgba(0,0,0,1)"; // color doesn’t matter
                } else {
                    ctx.globalCompositeOperation = "source-over";
                    ctx.strokeStyle = currentColor;
                }
                ctx.lineTo(x, y);
                ctx.stroke();
            }

            // Restore drawing
            if (drawingData?.value?.startsWith("data:image")) {
                const img = new Image();
                img.onload = () => ctx.drawImage(img, 0, 0);
                img.src = drawingData.value;
            } else {
                console.warn("No drawing data to restore");
            }
        });
    </script>
</body>

</html>
